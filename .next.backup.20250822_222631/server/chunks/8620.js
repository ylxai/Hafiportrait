"use strict";exports.id=8620,exports.ids=[8620,7066],exports.modules={68620:(e,t,a)=>{let s;a.d(t,{F:()=>n});var i=a(87066);try{s=a(57441)}catch(e){console.warn("Sharp not available, image optimization disabled"),s=null}class r{constructor(e,t="photos"){this.supabase=e,this.bucketName=t}generateFilename(e,t,a){let s=e.split(".").pop()?.toLowerCase()||"jpg",i=e.replace(/\.[^/.]+$/,"").replace(/[^a-zA-Z0-9]/g,"_");return`${a}_${i}_${t}.${s}`}async optimizeImage(e,t,a,i){return s?await s(e).resize(t,a,{fit:"inside",withoutEnlargement:!0,background:{r:255,g:255,b:255,alpha:1}}).jpeg({quality:i,progressive:!0,mozjpeg:!0}).toBuffer():e}async getImageMetadata(e){if(!s)return{width:1920,height:1080,format:"jpeg",size:e.length};let t=await s(e).metadata();return{width:t.width||0,height:t.height||0,format:t.format||"jpeg",size:e.length}}async uploadToStorage(e,t,a="image/jpeg"){let{data:s,error:i}=await this.supabase.storage.from(this.bucketName).upload(t,e,{contentType:a,cacheControl:"31536000",upsert:!1});if(i)throw i;let{data:r}=this.supabase.storage.from(this.bucketName).getPublicUrl(s.path);return r.publicUrl}async processImage(e,t,a="optimized"){try{let t=await this.getImageMetadata(e),s=Date.now(),i=Math.random().toString(36).substring(2,8),r=`${a}/original/${s}_${i}_original.jpg`,o={original:{url:await this.uploadToStorage(e,r),size:t.size,width:t.width,height:t.height},thumbnail:{url:"",size:0},small:{url:"",size:0},medium:{url:"",size:0},large:{url:"",size:0}};for(let[t,r]of Object.entries({thumbnail:{width:300,height:225,quality:85},small:{width:800,height:600,quality:90},medium:{width:1200,height:900,quality:92},large:{width:1920,height:1440,quality:95}})){let n=await this.optimizeImage(e,r.width,r.height,r.quality),l=`${a}/${t}/${s}_${i}_${t}.jpg`,h=await this.uploadToStorage(n,l);o[t]={url:h,size:n.length}}return o}catch(e){throw console.error("Image processing error:",e),Error("Failed to process image")}}static getOptimalImageUrl(e,t){switch(t){case"thumbnail":return e.thumbnail.url;case"gallery":default:return e.medium.url;case"lightbox":return e.large.url;case"download":return e.original.url;case"mobile":return e.small.url}}static getResponsiveSources(e){return{srcSet:`${e.small.url} 800w, ${e.medium.url} 1200w, ${e.large.url} 1920w`,sizes:"(max-width: 768px) 800px, (max-width: 1200px) 1200px, 1920px",src:e.medium.url,placeholder:e.thumbnail.url}}static getCompressionStats(e){let t=e.original.size,a=e.medium.size,s=(t-a)/t*100;return{originalSize:this.formatFileSize(t),optimizedSize:this.formatFileSize(a),savings:Math.round(s),ratio:`${Math.round(t/a)}:1`}}static formatFileSize(e){if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}}class o{constructor(){this.supabase=i.supabaseAdmin,this.imageOptimizer=new r(this.supabase,"photos")}async getAllEvents(){let{data:e,error:t}=await this.supabase.from("events").select("*").order("date",{ascending:!1});if(t)throw t;return e}async getPublicEvents(){let{data:e,error:t}=await this.supabase.from("events").select("id, name, date, access_code, is_premium, qr_code, shareable_link, status, is_archived, photo_count").is("is_premium",!1).order("date",{ascending:!1});if(t)throw t;return e}async getEventById(e){let{data:t,error:a}=await this.supabase.from("events").select("*").eq("id",e).single();if(a)throw a;return t}async createEvent(e){let{data:t,error:a}=await this.supabase.from("events").insert(e).select().single();if(a)throw a;try{let e=function(){{let e="http://147.251.255.227:3002";if(e&&!e.includes("localhost"))return e}return process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:process.env.CF_PAGES_URL?process.env.CF_PAGES_URL:process.env.RAILWAY_STATIC_URL?process.env.RAILWAY_STATIC_URL:process.env.NETLIFY_URL?process.env.NETLIFY_URL:"https://hafiportrait.photography"}(),a=`${e}/event/${t.id}?code=${t.access_code}`,s=`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(a)}`,{data:i,error:r}=await this.supabase.from("events").update({qr_code:s,shareable_link:a}).eq("id",t.id).select().single();if(r)throw r;return i}catch(e){return console.error("Error generating QR code:",e),t}}async updateEvent(e,t){let{data:a,error:s}=await this.supabase.from("events").update(t).eq("id",e).select().single();if(s)throw s;return a}async deleteEvent(e){try{let{data:t,error:a}=await this.supabase.from("photos").select("*").eq("event_id",e);if(a&&console.error("Error fetching event photos for deletion:",a),t&&t.length>0)for(let e of t)try{await this.deletePhoto(e.id)}catch(t){console.error(`Error deleting photo ${e.id}:`,t)}let{error:s}=await this.supabase.from("messages").delete().eq("event_id",e);s&&console.error("Error deleting event messages:",s);let{error:i}=await this.supabase.from("photos").delete().eq("event_id",e);i&&console.error("Error deleting remaining event photos:",i);let{error:r}=await this.supabase.from("events").delete().eq("id",e);if(r)throw r;console.log(`Event ${e} and all related data deleted successfully`)}catch(e){throw console.error("Error in deleteEvent:",e),e}}async updateEventStatus(e,t){let a={status:t};"archived"===t?(a.is_archived=!0,a.archived_at=new Date().toISOString()):"active"===t&&a.is_archived&&(a.is_archived=!1,a.archived_at=null);let{data:s,error:i}=await this.supabase.from("events").update(a).eq("id",e).select().single();if(i)throw i;return s}async getEventWithStats(e){let{data:t,error:a}=await this.supabase.from("events").select("*").eq("id",e).single();if(a)throw a;if(!t)return null;let{count:s,error:i}=await this.supabase.from("photos").select("*",{count:"exact",head:!0}).eq("event_id",e),{count:r,error:o}=await this.supabase.from("messages").select("*",{count:"exact",head:!0}).eq("event_id",e),{data:n}=await this.supabase.from("photos").select("uploaded_at").eq("event_id",e).order("uploaded_at",{ascending:!1}).limit(1).single(),{data:l}=await this.supabase.from("messages").select("created_at").eq("event_id",e).order("created_at",{ascending:!1}).limit(1).single(),h=null;n&&l?h=new Date(n.uploaded_at)>new Date(l.created_at)?n.uploaded_at:l.created_at:n?h=n.uploaded_at:l&&(h=l.created_at);let{data:d}=await this.supabase.from("photos").select("uploader_name").eq("event_id",e).not("uploader_name","is",null),{data:u}=await this.supabase.from("messages").select("guest_name").eq("event_id",e).not("guest_name","is",null),p=new Set([...d?.map(e=>e.uploader_name)||[],...u?.map(e=>e.guest_name)||[]]);return{...t,photo_count:s||0,message_count:r||0,participant_count:p.size,last_activity:h}}async verifyEventAccessCode(e,t){let{data:a,error:s}=await this.supabase.from("events").select("id").eq("id",e).eq("access_code",t).single();return!s&&!!a}async getEventPhotos(e){let{data:t,error:a}=await this.supabase.from("photos").select("*").eq("event_id",e).order("uploaded_at",{ascending:!1});if(a)throw a;return t}async getHomepagePhotos(){let{data:e,error:t}=await this.supabase.from("photos").select("*").eq("is_homepage",!0).order("uploaded_at",{ascending:!1});if(t)throw t.code,t;return e}validateFileExtension(e){let t=e.split(".").pop()?.toLowerCase();return!!t&&["jpg","jpeg","png","gif","webp"].includes(t)}generateFileName(e){let t=e.split(".").pop()?.toLowerCase()||"jpg",a=Date.now(),s=Math.random().toString(36).substring(2,8);return`${a}_${s}.${t}`}async getEvents(){let{data:e,error:t}=await this.supabase.from("events").select("*").order("date",{ascending:!1});if(t)throw t;return e||[]}async getSimpleCompressionAnalytics(){try{let{data:e,error:t}=await this.supabase.from("photos").select("*").not("optimized_images","is",null).order("uploaded_at",{ascending:!1}).limit(100);if(t)throw t;let a=e?.length||0,s=0,i=0,r=0,o=[];e?.forEach(e=>{if(e.image_metadata&&e.optimized_images){let t=e.image_metadata.original_size||0,a=e.optimized_images.medium?.size||0,n=t-a;s+=t,i+=a,r+=n,o.length<10&&o.push({id:e.id,original_name:e.original_name,original_size:t,optimized_size:a,savings_percentage:t>0?n/t*100:0,uploaded_at:e.uploaded_at})}});let n=s>0?r/s*100:0,l=i>0?s/i:1;return{totalPhotos:a,totalOriginalSize:s,totalOptimizedSize:i,totalSavingsBytes:r,totalSavingsPercentage:n,storageSaved:this.formatFileSize(r),averageCompressionRatio:l,recentPhotos:o.sort((e,t)=>t.savings_percentage-e.savings_percentage)}}catch(e){throw console.error("Error getting simple compression analytics:",e),e}}formatFileSize(e){if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}async validateEventAccess(e){let{data:t,error:a}=await this.supabase.from("events").select("id, is_premium").eq("id",e).single();if(a||!t)throw Error("Event not found");return!0}async uploadEventPhoto(e,t,s="Anonymous",i="Tamu"){if(await this.validateEventAccess(e),!this.validateFileExtension(t.name))throw Error("Invalid file type. Allowed: jpg, jpeg, png, gif, webp");try{let o=await t.arrayBuffer(),n=Buffer.from(o),l=await this.imageOptimizer.processImage(n,t.name,`events/${e}`),h=(await Promise.resolve().then(a.t.bind(a,57441,23))).default,d=await h(n).metadata(),u={width:d.width||0,height:d.height||0,format:d.format||"jpeg",original_size:n.length},p=r.getCompressionStats(l),{data:c,error:m}=await this.supabase.from("photos").insert({event_id:e,url:l.original.url,thumbnail_url:l.thumbnail.url,original_name:t.name,uploader_name:s,album_name:i,is_homepage:!1,filename:this.generateFileName(t.name),optimized_images:l,image_metadata:u,compression_stats:p}).select().single();if(m)throw m;return c}catch(e){throw console.error("Error uploading optimized event photo:",e),e}}async uploadHomepagePhoto(e){if(!this.validateFileExtension(e.name))throw Error("Invalid file type. Allowed: jpg, jpeg, png, gif, webp");try{let t=await e.arrayBuffer(),s=Buffer.from(t),i=await this.imageOptimizer.processImage(s,e.name,"homepage"),o=(await Promise.resolve().then(a.t.bind(a,57441,23))).default,n=await o(s).metadata(),l={width:n.width||0,height:n.height||0,format:n.format||"jpeg",original_size:s.length},h=r.getCompressionStats(i),{data:d,error:u}=await this.supabase.from("photos").insert({url:i.original.url,thumbnail_url:i.thumbnail.url,original_name:e.name,is_homepage:!0,event_id:null,uploader_name:"Admin",album_name:"Homepage",filename:this.generateFileName(e.name),optimized_images:i,image_metadata:l,compression_stats:h}).select().single();if(u)throw u;return d}catch(e){throw console.error("Error uploading optimized homepage photo:",e),e}}async getPhotoById(e){let{data:t,error:a}=await this.supabase.from("photos").select("*").eq("id",e).single();if(a)throw a;return t}async deletePhoto(e){let t=await this.getPhotoById(e);if(!t)throw Error("Photo not found");try{let a;if(t.filename)a=t.is_homepage?`homepage/${t.filename}`:t.event_id?`events/${t.event_id}/${t.filename}`:t.filename;else{let e=t.url.split("/"),s=e[e.length-1];a=t.is_homepage?`homepage/${s}`:t.event_id?`events/${t.event_id}/${s}`:s}let{error:s}=await this.supabase.storage.from("photos").remove([a]),{error:i}=await this.supabase.from("photos").delete().eq("id",e);if(i)throw i}catch(a){if(a instanceof Error&&!a.message.includes("storage"))throw a;let{error:t}=await this.supabase.from("photos").delete().eq("id",e);if(t)throw t}}async likePhoto(e){let{data:t,error:a}=await this.supabase.rpc("increment_likes",{photo_id:e});if(a)throw a}async getEventMessages(e){let{data:t,error:a}=await this.supabase.from("messages").select("*").eq("event_id",e).order("created_at",{ascending:!1});if(a)throw a;return t}async createMessage(e){let{data:t,error:a}=await this.supabase.from("messages").insert(e).select().single();if(a)throw a;return t}async heartMessage(e){let{data:t,error:a}=await this.supabase.rpc("increment_hearts",{message_id:e});if(a)throw a}async getMessageById(e){let{data:t,error:a}=await this.supabase.from("messages").select("*").eq("id",e).single();if(a)throw a;return t}async updateMessageHearts(e,t){let{error:a}=await this.supabase.from("messages").update({hearts:t}).eq("id",e);if(a)throw a}async addMessageReaction(e,t){let a=await this.getMessageById(e);if(!a)throw Error("Message not found");let s=a.reactions||{love:0,laugh:0,wow:0,sad:0,angry:0};s[t]=(s[t]||0)+1;let{error:i}=await this.supabase.from("messages").update({reactions:s}).eq("id",e);if(i)throw i}async updateMessageReactions(e,t){let{error:a}=await this.supabase.from("messages").update({reactions:t}).eq("id",e);if(a)throw a}async getStats(){let{count:e,error:t}=await this.supabase.from("events").select("*",{count:"exact",head:!0});if(t)throw t;let{count:a,error:s}=await this.supabase.from("photos").select("*",{count:"exact",head:!0});if(s)throw s;let{count:i,error:r}=await this.supabase.from("messages").select("*",{count:"exact",head:!0});if(r)throw r;return{totalEvents:e||0,totalPhotos:a||0,totalMessages:i||0}}}let n=new o},87066:(e,t,a)=>{a.d(t,{OQ:()=>r,eI:()=>n,supabaseAdmin:()=>o});var s=a(33716);let i=()=>"https://azspktldiblhrwebzmwq.supabase.co",r=(0,s.eI)(i(),(()=>{let e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6c3BrdGxkaWJsaHJ3ZWJ6bXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NDQwNDQsImV4cCI6MjA2OTUyMDA0NH0.uKHB4K9hxUDTc0ZkwidCJv_Ev-oa99AflFvrFt_8MG8";if(!e)throw Error("NEXT_PUBLIC_SUPABASE_ANON_KEY environment variable is required");return e})()),o=(0,s.eI)(i(),(()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e)throw Error("SUPABASE_SERVICE_ROLE_KEY environment variable is required");return e})(),{auth:{autoRefreshToken:!1,persistSession:!1}});function n(){return(0,s.eI)("https://azspktldiblhrwebzmwq.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}process.env.SUPABASE_STORAGE_BUCKET}};