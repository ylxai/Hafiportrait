"use strict";(()=>{var e={};e.id=2943,e.ids=[2943,6940],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},57441:e=>{e.exports=require("sharp")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},7026:e=>{e.exports=require("googleapis")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},84492:e=>{e.exports=require("node:stream")},52245:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>c,routeModule:()=>g,serverHooks:()=>m,staticGenerationAsyncStorage:()=>h});var s={};a.r(s),a.d(s,{GET:()=>p,POST:()=>u});var o=a(30633),r=a(86488),i=a(13342),n=a(90223),l=a(68620),d=a(36940);async function p(e,{params:t}){let{id:a}=await t;if(!a)return n.NextResponse.json({error:"Event ID is required"},{status:400});try{let e=await l.F.getEventPhotos(a);return n.NextResponse.json(e)}catch(e){return console.error("Get photos error:",e),n.NextResponse.json({error:"Failed to fetch event photos",details:e.message},{status:500})}}async function u(e,{params:t}){try{let{id:a}=await t,s=await e.formData(),o=s.get("file"),r=s.get("uploaderName")||"Anonymous",i=s.get("albumName")||"Tamu";if(!a)return n.NextResponse.json({message:"Event ID is required"},{status:400});if(!o)return n.NextResponse.json({message:"No file uploaded"},{status:400});if(!o.type.startsWith("image/"))return n.NextResponse.json({message:"Only image files are allowed"},{status:400});if(o.size>10485760)return n.NextResponse.json({message:"File size must be less than 10MB"},{status:400});if(!["Official","Tamu","Bridesmaid"].includes(i))return n.NextResponse.json({message:"Invalid album name"},{status:400});let l=await d.smartDatabase.uploadEventPhoto(a,o,r,i);if(!l)throw Error("Failed to create photo record");return n.NextResponse.json(l,{status:201})}catch(t){let e=t instanceof Error?t.message:"Unknown error occurred";return n.NextResponse.json({message:`Failed to upload photo: ${e}`,details:void 0},{status:500})}}let g=new o.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/events/[id]/photos/route",pathname:"/api/events/[id]/photos",filename:"route",bundlePath:"app/api/events/[id]/photos/route"},resolvedPagePath:"/home/ubuntu/stable/src/app/api/events/[id]/photos/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:c,staticGenerationAsyncStorage:h,serverHooks:m}=g,f="/api/events/[id]/photos/route";function v(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:h})}},36940:(e,t,a)=>{a.d(t,{smartDatabase:()=>n});var s=a(68620),o=a(61646),r=a(87066);class i{async uploadEventPhoto(e,t,a="Anonymous",r="Tamu"){if(await s.F.validateEventAccess(e),!this.validateFileExtension(t.name))throw Error("Invalid file type. Allowed: jpg, jpeg, png, gif, webp");try{let s={eventId:e,albumName:r,uploaderName:a,isHomepage:!1,isPremium:"Official"===r,isFeatured:"Official"===r,fileSize:t.size,eventType:"wedding",fileType:t.type};console.log(`ðŸŽ¯ Uploading event photo via Smart Storage Manager`),console.log(`ðŸ“Š Event: ${e}, Album: ${r}, Uploader: ${a}`);let i=await o.C.uploadPhoto(t,s);console.log(`âœ… Smart Storage upload successful:`,{tier:i.tier,storage:i.storage,compression:i.compressionUsed});let{data:n,error:l}=await this.supabase.from("photos").insert({event_id:e,url:i.url,thumbnail_url:i.thumbnailUrl,original_name:t.name,uploader_name:a,album_name:r,is_homepage:!1,filename:this.generateFileName(t.name),storage_tier:i.tier,storage_provider:i.storage,compression_used:i.compressionUsed,file_size:i.size,storage_path:i.path,storage_etag:i.etag,storage_file_id:i.fileId}).select().single();if(l)throw console.error("âŒ Database insert failed:",l),l;return console.log(`âœ… Photo saved to database with Smart Storage metadata`),n}catch(o){console.error("âŒ Smart Storage upload failed:",o),console.log("\uD83D\uDD04 Falling back to original upload method...");try{return await s.F.uploadEventPhoto(e,t,a,r)}catch(e){throw console.error("âŒ Fallback upload also failed:",e),Error(`Both Smart Storage and fallback upload failed. Last error: ${e instanceof Error?e.message:"Unknown error"}`)}}}async uploadHomepagePhoto(e){if(!this.validateFileExtension(e.name))throw Error("Invalid file type. Allowed: jpg, jpeg, png, gif, webp");try{let t={albumName:"Homepage",uploaderName:"Admin",isHomepage:!0,isPremium:!0,isFeatured:!0,fileSize:e.size,eventType:"homepage",fileType:e.type};console.log(`ðŸŽ¯ Uploading homepage photo via Smart Storage Manager`);let a=await o.C.uploadPhoto(e,t);console.log(`âœ… Smart Storage homepage upload successful:`,{tier:a.tier,storage:a.storage,compression:a.compressionUsed});let{data:s,error:r}=await this.supabase.from("photos").insert({url:a.url,thumbnail_url:a.thumbnailUrl,original_name:e.name,is_homepage:!0,event_id:null,uploader_name:"Admin",album_name:"Homepage",filename:this.generateFileName(e.name),storage_tier:a.tier,storage_provider:a.storage,compression_used:a.compressionUsed,file_size:a.size,storage_path:a.path,storage_etag:a.etag,storage_file_id:a.fileId}).select().single();if(r)throw console.error("âŒ Database insert failed:",r),r;return console.log(`âœ… Homepage photo saved to database with Smart Storage metadata`),s}catch(t){console.error("âŒ Smart Storage homepage upload failed:",t),console.log("\uD83D\uDD04 Falling back to original upload method...");try{return await s.F.uploadHomepagePhoto(e)}catch(e){throw console.error("âŒ Fallback upload also failed:",e),Error(`Both Smart Storage and fallback upload failed. Last error: ${e instanceof Error?e.message:"Unknown error"}`)}}}async getStorageAnalytics(){try{let e=await o.C.getStorageReport(),{data:t,error:a}=await this.supabase.from("photos").select("storage_tier, storage_provider, file_size, compression_used, uploaded_at").not("storage_tier","is",null);a&&console.warn("âš ï¸ Could not fetch storage analytics from database:",a);let s=t?.reduce((e,t)=>{let a=t.storage_tier||"unknown";return e[a]||(e[a]={count:0,totalSize:0}),e[a].count++,e[a].totalSize+=t.file_size||0,e},{})||{};return{storageReport:e,tierStats:s,totalPhotosWithSmartStorage:t?.length||0,recentUploads:t?.slice(0,10)||[]}}catch(e){throw console.error("âŒ Error getting storage analytics:",e),e}}async cleanupOldFiles(e=30){await o.C.cleanupOldFiles(e)}validateFileExtension(e){let t=e.split(".").pop()?.toLowerCase();return!!t&&["jpg","jpeg","png","gif","webp"].includes(t)}generateFileName(e){let t=e.split(".").pop()?.toLowerCase()||"jpg",a=Date.now(),s=Math.random().toString(36).substring(2,8);return`${a}_${s}.${t}`}constructor(){this.supabase=r.supabaseAdmin,this.getAllEvents=s.F.getAllEvents.bind(s.F),this.getPublicEvents=s.F.getPublicEvents.bind(s.F),this.getEventById=s.F.getEventById.bind(s.F),this.createEvent=s.F.createEvent.bind(s.F),this.updateEvent=s.F.updateEvent.bind(s.F),this.deleteEvent=s.F.deleteEvent.bind(s.F),this.verifyEventAccessCode=s.F.verifyEventAccessCode.bind(s.F),this.getEventPhotos=s.F.getEventPhotos.bind(s.F),this.getHomepagePhotos=s.F.getHomepagePhotos.bind(s.F),this.getPhotoById=s.F.getPhotoById.bind(s.F),this.deletePhoto=s.F.deletePhoto.bind(s.F),this.likePhoto=s.F.likePhoto.bind(s.F),this.getEventMessages=s.F.getEventMessages.bind(s.F),this.createMessage=s.F.createMessage.bind(s.F),this.heartMessage=s.F.heartMessage.bind(s.F),this.getMessageById=s.F.getMessageById.bind(s.F),this.updateMessageHearts=s.F.updateMessageHearts.bind(s.F),this.addMessageReaction=s.F.addMessageReaction.bind(s.F),this.updateMessageReactions=s.F.updateMessageReactions.bind(s.F),this.getStats=s.F.getStats.bind(s.F),this.getEvents=s.F.getEvents.bind(s.F),this.getSimpleCompressionAnalytics=s.F.getSimpleCompressionAnalytics.bind(s.F),this.validateEventAccess=s.F.validateEventAccess.bind(s.F)}}let n=new i},61646:(e,t,a)=>{a.d(t,{C:()=>r});let s=a(82481);class o{constructor(){this.initialized=!1,this.storageManager=new s({local:{backupFolder:process.env.LOCAL_BACKUP_PATH||"./DSLR-System/Backup/dslr-backup"}})}async initialize(){this.initialized||(await this.storageManager.initializeProviders(),this.initialized=!0,console.log("âœ… Storage Adapter initialized"))}async uploadPhoto(e,t){await this.initialize();let a=await e.arrayBuffer(),s={buffer:Buffer.from(a),name:e.name,size:e.size,type:e.type},o={eventId:t.eventId,albumName:t.albumName,uploaderName:t.uploaderName,isHomepage:t.isHomepage,isPremium:t.isPremium||!1,isFeatured:t.isFeatured||!1,fileSize:t.fileSize,eventType:t.eventType||"standard",fileType:t.fileType};console.log(`ðŸš€ Uploading ${e.name} via Smart Storage Manager`),console.log(`ðŸ“Š Metadata:`,o);try{let e=await this.storageManager.uploadPhoto(s,o);return console.log(`âœ… Upload successful:`,{tier:e.tier,storage:e.storage,url:e.url,size:e.size}),e}catch(e){throw console.error("âŒ Storage upload failed:",e),Error(`Storage upload failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async getStorageReport(){return await this.initialize(),this.storageManager.getStorageReport()}async cleanupOldFiles(e=30){await this.initialize(),await this.storageManager.cleanupOldFiles(e)}async hasStorageSpace(e,t){return await this.initialize(),this.storageManager.hasSpace(e,t)}async determineStorageTier(e){return await this.initialize(),this.storageManager.determineStorageTier(e)}}let r=new o}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[2782,606,3716,7851,8620,2481],()=>a(52245));module.exports=s})();