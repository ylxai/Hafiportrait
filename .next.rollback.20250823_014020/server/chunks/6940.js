"use strict";exports.id=6940,exports.ids=[6940],exports.modules={36940:(e,t,a)=>{a.d(t,{smartDatabase:()=>n});var o=a(68620),i=a(61646),s=a(87066);class r{async uploadEventPhoto(e,t,a="Anonymous",s="Tamu"){if(await o.F.validateEventAccess(e),!this.validateFileExtension(t.name))throw Error("Invalid file type. Allowed: jpg, jpeg, png, gif, webp");try{let o={eventId:e,albumName:s,uploaderName:a,isHomepage:!1,isPremium:"Official"===s,isFeatured:"Official"===s,fileSize:t.size,eventType:"wedding",fileType:t.type};console.log(`üéØ Uploading event photo via Smart Storage Manager`),console.log(`üìä Event: ${e}, Album: ${s}, Uploader: ${a}`);let r=await i.C.uploadPhoto(t,o);console.log(`‚úÖ Smart Storage upload successful:`,{tier:r.tier,storage:r.storage,compression:r.compressionUsed});let{data:n,error:l}=await this.supabase.from("photos").insert({event_id:e,url:r.url,thumbnail_url:r.thumbnailUrl,original_name:t.name,uploader_name:a,album_name:s,is_homepage:!1,filename:this.generateFileName(t.name),storage_tier:r.tier,storage_provider:r.storage,compression_used:r.compressionUsed,file_size:r.size,storage_path:r.path,storage_etag:r.etag,storage_file_id:r.fileId}).select().single();if(l)throw console.error("‚ùå Database insert failed:",l),l;return console.log(`‚úÖ Photo saved to database with Smart Storage metadata`),n}catch(i){console.error("‚ùå Smart Storage upload failed:",i),console.log("\uD83D\uDD04 Falling back to original upload method...");try{return await o.F.uploadEventPhoto(e,t,a,s)}catch(e){throw console.error("‚ùå Fallback upload also failed:",e),Error(`Both Smart Storage and fallback upload failed. Last error: ${e instanceof Error?e.message:"Unknown error"}`)}}}async uploadHomepagePhoto(e){if(!this.validateFileExtension(e.name))throw Error("Invalid file type. Allowed: jpg, jpeg, png, gif, webp");try{let t={albumName:"Homepage",uploaderName:"Admin",isHomepage:!0,isPremium:!0,isFeatured:!0,fileSize:e.size,eventType:"homepage",fileType:e.type};console.log(`üéØ Uploading homepage photo via Smart Storage Manager`);let a=await i.C.uploadPhoto(e,t);console.log(`‚úÖ Smart Storage homepage upload successful:`,{tier:a.tier,storage:a.storage,compression:a.compressionUsed});let{data:o,error:s}=await this.supabase.from("photos").insert({url:a.url,thumbnail_url:a.thumbnailUrl,original_name:e.name,is_homepage:!0,event_id:null,uploader_name:"Admin",album_name:"Homepage",filename:this.generateFileName(e.name),storage_tier:a.tier,storage_provider:a.storage,compression_used:a.compressionUsed,file_size:a.size,storage_path:a.path,storage_etag:a.etag,storage_file_id:a.fileId}).select().single();if(s)throw console.error("‚ùå Database insert failed:",s),s;return console.log(`‚úÖ Homepage photo saved to database with Smart Storage metadata`),o}catch(t){console.error("‚ùå Smart Storage homepage upload failed:",t),console.log("\uD83D\uDD04 Falling back to original upload method...");try{return await o.F.uploadHomepagePhoto(e)}catch(e){throw console.error("‚ùå Fallback upload also failed:",e),Error(`Both Smart Storage and fallback upload failed. Last error: ${e instanceof Error?e.message:"Unknown error"}`)}}}async getStorageAnalytics(){try{let e=await i.C.getStorageReport(),{data:t,error:a}=await this.supabase.from("photos").select("storage_tier, storage_provider, file_size, compression_used, uploaded_at").not("storage_tier","is",null);a&&console.warn("‚ö†Ô∏è Could not fetch storage analytics from database:",a);let o=t?.reduce((e,t)=>{let a=t.storage_tier||"unknown";return e[a]||(e[a]={count:0,totalSize:0}),e[a].count++,e[a].totalSize+=t.file_size||0,e},{})||{};return{storageReport:e,tierStats:o,totalPhotosWithSmartStorage:t?.length||0,recentUploads:t?.slice(0,10)||[]}}catch(e){throw console.error("‚ùå Error getting storage analytics:",e),e}}async cleanupOldFiles(e=30){await i.C.cleanupOldFiles(e)}validateFileExtension(e){let t=e.split(".").pop()?.toLowerCase();return!!t&&["jpg","jpeg","png","gif","webp"].includes(t)}generateFileName(e){let t=e.split(".").pop()?.toLowerCase()||"jpg",a=Date.now(),o=Math.random().toString(36).substring(2,8);return`${a}_${o}.${t}`}constructor(){this.supabase=s.supabaseAdmin,this.getAllEvents=o.F.getAllEvents.bind(o.F),this.getPublicEvents=o.F.getPublicEvents.bind(o.F),this.getEventById=o.F.getEventById.bind(o.F),this.createEvent=o.F.createEvent.bind(o.F),this.updateEvent=o.F.updateEvent.bind(o.F),this.deleteEvent=o.F.deleteEvent.bind(o.F),this.verifyEventAccessCode=o.F.verifyEventAccessCode.bind(o.F),this.getEventPhotos=o.F.getEventPhotos.bind(o.F),this.getHomepagePhotos=o.F.getHomepagePhotos.bind(o.F),this.getPhotoById=o.F.getPhotoById.bind(o.F),this.deletePhoto=o.F.deletePhoto.bind(o.F),this.likePhoto=o.F.likePhoto.bind(o.F),this.getEventMessages=o.F.getEventMessages.bind(o.F),this.createMessage=o.F.createMessage.bind(o.F),this.heartMessage=o.F.heartMessage.bind(o.F),this.getMessageById=o.F.getMessageById.bind(o.F),this.updateMessageHearts=o.F.updateMessageHearts.bind(o.F),this.addMessageReaction=o.F.addMessageReaction.bind(o.F),this.updateMessageReactions=o.F.updateMessageReactions.bind(o.F),this.getStats=o.F.getStats.bind(o.F),this.getEvents=o.F.getEvents.bind(o.F),this.getSimpleCompressionAnalytics=o.F.getSimpleCompressionAnalytics.bind(o.F),this.validateEventAccess=o.F.validateEventAccess.bind(o.F)}}let n=new r},61646:(e,t,a)=>{a.d(t,{C:()=>s});let o=a(82481);class i{constructor(){this.initialized=!1,this.storageManager=new o({local:{backupFolder:process.env.LOCAL_BACKUP_PATH||"./DSLR-System/Backup/dslr-backup"}})}async initialize(){this.initialized||(await this.storageManager.initializeProviders(),this.initialized=!0,console.log("‚úÖ Storage Adapter initialized"))}async uploadPhoto(e,t){await this.initialize();let a=await e.arrayBuffer(),o={buffer:Buffer.from(a),name:e.name,size:e.size,type:e.type},i={eventId:t.eventId,albumName:t.albumName,uploaderName:t.uploaderName,isHomepage:t.isHomepage,isPremium:t.isPremium||!1,isFeatured:t.isFeatured||!1,fileSize:t.fileSize,eventType:t.eventType||"standard",fileType:t.fileType};console.log(`üöÄ Uploading ${e.name} via Smart Storage Manager`),console.log(`üìä Metadata:`,i);try{let e=await this.storageManager.uploadPhoto(o,i);return console.log(`‚úÖ Upload successful:`,{tier:e.tier,storage:e.storage,url:e.url,size:e.size}),e}catch(e){throw console.error("‚ùå Storage upload failed:",e),Error(`Storage upload failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async getStorageReport(){return await this.initialize(),this.storageManager.getStorageReport()}async cleanupOldFiles(e=30){await this.initialize(),await this.storageManager.cleanupOldFiles(e)}async hasStorageSpace(e,t){return await this.initialize(),this.storageManager.hasSpace(e,t)}async determineStorageTier(e){return await this.initialize(),this.storageManager.determineStorageTier(e)}}let s=new i}};