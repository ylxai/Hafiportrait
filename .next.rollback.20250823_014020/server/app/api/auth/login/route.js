"use strict";(()=>{var e={};e.id=8873,e.ids=[8873],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},94698:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var o={};r.r(o),r.d(o,{OPTIONS:()=>d,POST:()=>p});var s=r(30633),a=r(86488),n=r(13342),i=r(90223),l=r(88347),c=r(28458),u=r(35872);async function d(e){let t=e.headers.get("origin")||e.headers.get("referer")||void 0;return console.log("OPTIONS request from origin:",t),(0,u.A6)(t)}async function p(e){let t=e.headers.get("origin")||e.headers.get("referer")||void 0;console.log("POST request from origin:",t),console.log("Request URL:",e.url),console.log("Request method:",e.method);try{let r,o,s;if("POST"!==e.method)return console.log("Invalid method:",e.method),(0,u.qb)("Method not allowed",405,t);let a={NEXT_PUBLIC_SUPABASE_URL:"https://azspktldiblhrwebzmwq.supabase.co",SUPABASE_SERVICE_ROLE_KEY:process.env.SUPABASE_SERVICE_ROLE_KEY,JWT_SECRET:process.env.JWT_SECRET},n=Object.entries(a).filter(([e,t])=>!t||"hafiportrait-secret-key-change-in-production"===t).map(([e])=>e);if(n.length>0)return console.error("Missing required environment variables:",n),(0,u.qb)("Server configuration error",500,t);try{r=await e.json(),console.log("Request body:",{...r,password:"[HIDDEN]"})}catch(e){return console.error("JSON parse error:",e),(0,u.qb)("Invalid JSON in request body",400,t)}let{username:d,password:p}=r;if(!d||!p)return console.log("Missing credentials"),(0,u.qb)("Username dan password harus diisi",400,t);if(d.length<3||d.length>50)return console.log("Invalid username length:",d.length),(0,u.qb)("Username harus antara 3-50 karakter",400,t);if(p.length<6||p.length>100)return console.log("Invalid password length:",p.length),(0,u.qb)("Password harus antara 6-100 karakter",400,t);if(!/^[a-zA-Z0-9_]+$/.test(d))return console.log("Invalid username format"),(0,u.qb)("Username hanya boleh berisi huruf, angka, dan underscore",400,t);let h=((e.headers.get("x-forwarded-for")||"").split(",")[0]||e.headers.get("x-real-ip")||"").trim()||"unknown",g=e.headers.get("user-agent")||"unknown";console.log("Client info:",{ipAddress:h,userAgent:g.substring(0,100)}),console.log("Attempting authentication for username:",d);try{let e=(0,l.So)({username:d,password:p}),t=new Promise((e,t)=>setTimeout(()=>t(Error("Authentication timeout")),3e4));o=await Promise.race([e,t])}catch(e){return console.error("Authentication error:",e),(0,u.qb)("Terjadi kesalahan saat autentikasi. Silakan coba lagi.",500,t)}if(!o){console.log("Authentication failed for username:",d);try{await (0,l.ag)(0,"login_failed","auth",d,{reason:"invalid_credentials",ip_address:h,user_agent:g},h,g)}catch(e){console.error("Failed to log activity:",e)}return(0,u.qb)("Username atau password salah",401,t)}if(console.log("Authentication successful for user:",o.username),"active"!==o.status&&!0!==o.is_active){console.log("User account inactive:",o.username);try{await (0,l.ag)(o.id,"login_failed","auth",o.username,{reason:"account_inactive",ip_address:h,user_agent:g},h,g)}catch(e){console.error("Failed to log activity:",e)}return(0,u.qb)("Akun tidak aktif. Silakan hubungi administrator.",403,t)}console.log("Creating session for user:",o.username);try{let e=(0,l.ed)(o.id,h,g),t=new Promise((e,t)=>setTimeout(()=>t(Error("Session creation timeout")),3e4));s=await Promise.race([e,t])}catch(e){return console.error("Session creation error:",e),(0,u.qb)("Gagal membuat sesi. Silakan coba lagi.",500,t)}if(!s)return console.error("Failed to create session for user:",o.username),(0,u.qb)("Gagal membuat sesi. Silakan coba lagi.",500,t);console.log("Session created successfully:",s);try{await (0,l.ag)(o.id,"login_success","auth",o.username,{ip_address:h,user_agent:g,session_id:s},h,g)}catch(e){console.error("Failed to log activity:",e)}let m=await (0,c.cookies)(),f=e.headers.get("host")||"",_=(e.headers.get("x-forwarded-proto")||"").toLowerCase(),w="https"===_||t?.startsWith("https://")||e.url.startsWith("https://"),S=f.includes("localhost")||f.startsWith("127.0.0.1")||t?.includes("localhost")||t?.includes("127.0.0.1")||e.url.includes("localhost")||e.url.includes("127.0.0.1"),y={httpOnly:!0,secure:!1,sameSite:"lax",maxAge:86400,path:"/"};(!w||S)&&S?y.secure=!1:y.secure=!0;let v=f.endsWith("hafiportrait.photography")||f.endsWith(".hafiportrait.photography");v?(y.domain=".hafiportrait.photography",console.log("\uD83C\uDF10 Setting cookie domain for hafiportrait.photography")):console.log("\uD83C\uDF10 Leaving cookie domain undefined (host-only). Host:",f),console.log("\uD83D\uDD27 COOKIE DEBUG - Environment check:",{NODE_ENV:"production",NEXT_PUBLIC_APP_URL:"http://147.251.255.227:3002",isProduction:!0,isLocalhost:S,isHttps:w,isHafiPortraitDomain:v,hostHeader:f,requestUrl:e.url,origin:t,xfp:_,cookieSecure:y.secure,cookieDomain:y.domain,cookieOptions:JSON.stringify(y)}),console.log("\uD83C\uDF6A FINAL Cookie options before setting:",y),console.log("\uD83C\uDF6A Setting cookie with sessionId:",s);try{m.set("admin_session",s,y),console.log("\uD83C\uDF6A Cookie set successfully")}catch(e){console.error("\uD83C\uDF6A Cookie setting failed:",e)}let b={success:!0,user:{id:o.id,username:o.username,email:o.email,full_name:o.full_name,role:o.role,status:o.status||(o.is_active?"active":"inactive")},message:"Login berhasil",session:{expires_in:86400,created_at:new Date().toISOString()}};console.log("Login successful, preparing response with cookies");let A=i.NextResponse.json(b,{status:200});try{y.domain&&(A.cookies.set("admin_session",s,y),console.log("\uD83C\uDF6A Response cookie (domain) set"));let e={...y};delete e.domain,A.cookies.set("admin_session",s,e),console.log("\uD83C\uDF6A Response cookie (host-only) set")}catch(e){console.error("\uD83C\uDF6A Setting cookies on response failed:",e)}return(0,u.No)(A,t)}catch(e){return console.error("Login API error:",e),e instanceof Error&&e.message,(0,u.qb)("Terjadi kesalahan server. Silakan coba lagi nanti.",500,t)}}let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"/home/ubuntu/stable/src/app/api/auth/login/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:g,staticGenerationAsyncStorage:m,serverHooks:f}=h,_="/api/auth/login/route";function w(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},88347:(e,t,r)=>{r.d(t,{So:()=>u,ag:()=>g,ed:()=>d,je:()=>p,sd:()=>h});var o=r(91609);r(35551);var s=r(33716);let a="https://azspktldiblhrwebzmwq.supabase.co",n=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!a||!n)throw Error("Missing required Supabase environment variables in production");let i=(0,s.eI)(a,n,{auth:{autoRefreshToken:!1,persistSession:!1}}),l=process.env.JWT_SECRET;if(!l||"hafiportrait-secret-key-change-in-production"===l)throw Error("JWT_SECRET must be set in production environment");async function c(e,t){return await o.ZP.compare(e,t)}async function u(e){try{if(!a||!n)throw console.error("Missing Supabase configuration"),Error("Database configuration error");try{let{data:e,error:t}=await i.from("admin_users").select("id").limit(1);if(t)throw console.error("Database connection test failed:",t),Error("Database connection failed")}catch(e){throw console.error("Database connection error:",e),Error("Unable to connect to database")}let{data:t,error:r}=await i.from("admin_users").select("*").eq("username",e.username).eq("is_active",!0).single();if(r){if(console.error("Database query error:",r),"PGRST116"===r.code)return null;throw Error("Database query failed")}if(!t)return null;try{if(!await c(e.password,t.password_hash))return null}catch(e){return console.error("Password verification error:",e),null}try{await i.from("admin_users").update({last_login:new Date().toISOString()}).eq("id",t.id)}catch(e){console.error("Failed to update last login:",e)}let{password_hash:o,...s}=t;return s}catch(e){throw console.error("Authentication error:",e),e}}async function d(e,t,r){let o=`sess_${Date.now()}_${Math.random().toString(36).substring(2,15)}`,s=new Date(Date.now()+864e5).toISOString(),{error:a}=await i.from("admin_sessions").insert({id:o,user_id:e,expires_at:s,ip_address:t,user_agent:r});if(a)throw Error("Failed to create session");return o}async function p(e){try{let{data:t,error:r}=await i.from("admin_sessions").select(`
        *,
        admin_users (
          id, username, email, full_name, role, is_active, last_login, created_at
        )
      `).eq("id",e).gt("expires_at",new Date().toISOString()).single();if(r||!t||!t.admin_users)return null;return t.admin_users}catch(e){return console.error("Session validation error:",e),null}}async function h(e){await i.from("admin_sessions").delete().eq("id",e)}async function g(e,t,r,o,s,a,n){try{await i.from("admin_activity_logs").insert({user_id:e,action:t,resource:r,resource_id:o,details:s,ip_address:a,user_agent:n})}catch(e){console.error("Failed to log activity:",e)}}},35872:(e,t,r)=>{r.d(t,{A6:()=>c,No:()=>n,VM:()=>i,eN:()=>a,qb:()=>l});var o=r(90223);function s(){let e=["https://hafiportrait.photography","https://www.hafiportrait.photography","https://hafiportrait.vercel.app","https://hafiportrait-git-main.vercel.app","https://hafiportrait-git-develop.vercel.app","https://*.vercel.app","https://*.vercel.app/*","https://hafiportrait.com","https://www.hafiportrait.com"];if(e.push("http://147.251.255.227:3002"),process.env.ALLOWED_ORIGINS){let t=process.env.ALLOWED_ORIGINS.split(",").map(e=>e.trim());e.push(...t)}return e}function a(e){let t={"Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS, PATCH","Access-Control-Allow-Headers":"Content-Type, Authorization, X-Requested-With, X-API-Key, X-User-ID, X-User-Username, X-User-Role","Access-Control-Allow-Credentials":"true","Access-Control-Max-Age":"86400"};if(!e||function(e){let t=s();return!!("https://hafiportrait.photography"===e||"https://www.hafiportrait.photography"===e||!e||e.includes("localhost")||e.includes("127.0.0.1"))||!!t.includes(e)||t.some(t=>{if(t.includes("*")){let r=t.replace(/\*/g,".*");return RegExp(`^${r}$`).test(e)}return!1})}(e))t["Access-Control-Allow-Origin"]=e||"*";else{let e=s();t["Access-Control-Allow-Origin"]=e[0]||"*"}return t}function n(e,t){return Object.entries(a(t)).forEach(([t,r])=>{e.headers.set(t,r)}),e}function i(e,t=200,r){return n(o.NextResponse.json(e,{status:t}),r)}function l(e,t=500,r){return n(o.NextResponse.json({error:e,timestamp:new Date().toISOString(),path:"/api/auth/login"},{status:t}),r)}function c(e){return n(new o.NextResponse(null,{status:200}),e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[2782,606,3716,4869],()=>r(94698));module.exports=o})();