"use strict";(()=>{var e={};e.id=5373,e.ids=[5373,6940],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},57441:e=>{e.exports=require("sharp")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},7026:e=>{e.exports=require("googleapis")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},84492:e=>{e.exports=require("node:stream")},52252:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>f,patchFetch:()=>F,requestAsyncStorage:()=>c,routeModule:()=>u,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var r={};a.r(r),a.d(r,{GET:()=>p,POST:()=>d});var o=a(30633),s=a(86488),i=a(13342),n=a(90223),l=a(36940),g=a(61646);async function p(e){try{console.log("\uD83D\uDCCA Fetching storage analytics...");let e=await l.smartDatabase.getStorageAnalytics();return console.log("âœ… Storage analytics retrieved successfully"),n.NextResponse.json({success:!0,data:e,timestamp:new Date().toISOString()})}catch(e){return console.error("âŒ Error fetching storage analytics:",e),e instanceof Error&&e.message,n.NextResponse.json({success:!1,error:"Failed to fetch storage analytics",details:void 0},{status:500})}}async function d(e){try{let{action:t,retentionDays:a}=await e.json();if("cleanup"===t)return console.log(`ðŸ§¹ Starting cleanup with retention: ${a||30} days`),await l.smartDatabase.cleanupOldFiles(a||30),console.log("âœ… Cleanup completed successfully"),n.NextResponse.json({success:!0,message:"Cleanup completed successfully",timestamp:new Date().toISOString()});if("storage-report"===t){console.log("\uD83D\uDCCA Generating detailed storage report...");let e=await g.C.getStorageReport();return n.NextResponse.json({success:!0,data:e,timestamp:new Date().toISOString()})}return n.NextResponse.json({error:"Invalid action. Supported actions: cleanup, storage-report"},{status:400})}catch(e){return console.error("âŒ Error in storage analytics POST:",e),e instanceof Error&&e.message,n.NextResponse.json({success:!1,error:"Storage operation failed",details:void 0},{status:500})}}let u=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/admin/storage/analytics/route",pathname:"/api/admin/storage/analytics",filename:"route",bundlePath:"app/api/admin/storage/analytics/route"},resolvedPagePath:"/home/ubuntu/stable/src/app/api/admin/storage/analytics/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:c,staticGenerationAsyncStorage:m,serverHooks:h}=u,f="/api/admin/storage/analytics/route";function F(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},36940:(e,t,a)=>{a.d(t,{smartDatabase:()=>n});var r=a(68620),o=a(61646),s=a(87066);class i{async uploadEventPhoto(e,t,a="Anonymous",s="Tamu"){if(await r.F.validateEventAccess(e),!this.validateFileExtension(t.name))throw Error("Invalid file type. Allowed: jpg, jpeg, png, gif, webp");try{let r={eventId:e,albumName:s,uploaderName:a,isHomepage:!1,isPremium:"Official"===s,isFeatured:"Official"===s,fileSize:t.size,eventType:"wedding",fileType:t.type};console.log(`ðŸŽ¯ Uploading event photo via Smart Storage Manager`),console.log(`ðŸ“Š Event: ${e}, Album: ${s}, Uploader: ${a}`);let i=await o.C.uploadPhoto(t,r);console.log(`âœ… Smart Storage upload successful:`,{tier:i.tier,storage:i.storage,compression:i.compressionUsed});let{data:n,error:l}=await this.supabase.from("photos").insert({event_id:e,url:i.url,thumbnail_url:i.thumbnailUrl,original_name:t.name,uploader_name:a,album_name:s,is_homepage:!1,filename:this.generateFileName(t.name),storage_tier:i.tier,storage_provider:i.storage,compression_used:i.compressionUsed,file_size:i.size,storage_path:i.path,storage_etag:i.etag,storage_file_id:i.fileId}).select().single();if(l)throw console.error("âŒ Database insert failed:",l),l;return console.log(`âœ… Photo saved to database with Smart Storage metadata`),n}catch(o){console.error("âŒ Smart Storage upload failed:",o),console.log("\uD83D\uDD04 Falling back to original upload method...");try{return await r.F.uploadEventPhoto(e,t,a,s)}catch(e){throw console.error("âŒ Fallback upload also failed:",e),Error(`Both Smart Storage and fallback upload failed. Last error: ${e instanceof Error?e.message:"Unknown error"}`)}}}async uploadHomepagePhoto(e){if(!this.validateFileExtension(e.name))throw Error("Invalid file type. Allowed: jpg, jpeg, png, gif, webp");try{let t={albumName:"Homepage",uploaderName:"Admin",isHomepage:!0,isPremium:!0,isFeatured:!0,fileSize:e.size,eventType:"homepage",fileType:e.type};console.log(`ðŸŽ¯ Uploading homepage photo via Smart Storage Manager`);let a=await o.C.uploadPhoto(e,t);console.log(`âœ… Smart Storage homepage upload successful:`,{tier:a.tier,storage:a.storage,compression:a.compressionUsed});let{data:r,error:s}=await this.supabase.from("photos").insert({url:a.url,thumbnail_url:a.thumbnailUrl,original_name:e.name,is_homepage:!0,event_id:null,uploader_name:"Admin",album_name:"Homepage",filename:this.generateFileName(e.name),storage_tier:a.tier,storage_provider:a.storage,compression_used:a.compressionUsed,file_size:a.size,storage_path:a.path,storage_etag:a.etag,storage_file_id:a.fileId}).select().single();if(s)throw console.error("âŒ Database insert failed:",s),s;return console.log(`âœ… Homepage photo saved to database with Smart Storage metadata`),r}catch(t){console.error("âŒ Smart Storage homepage upload failed:",t),console.log("\uD83D\uDD04 Falling back to original upload method...");try{return await r.F.uploadHomepagePhoto(e)}catch(e){throw console.error("âŒ Fallback upload also failed:",e),Error(`Both Smart Storage and fallback upload failed. Last error: ${e instanceof Error?e.message:"Unknown error"}`)}}}async getStorageAnalytics(){try{let e=await o.C.getStorageReport(),{data:t,error:a}=await this.supabase.from("photos").select("storage_tier, storage_provider, file_size, compression_used, uploaded_at").not("storage_tier","is",null);a&&console.warn("âš ï¸ Could not fetch storage analytics from database:",a);let r=t?.reduce((e,t)=>{let a=t.storage_tier||"unknown";return e[a]||(e[a]={count:0,totalSize:0}),e[a].count++,e[a].totalSize+=t.file_size||0,e},{})||{};return{storageReport:e,tierStats:r,totalPhotosWithSmartStorage:t?.length||0,recentUploads:t?.slice(0,10)||[]}}catch(e){throw console.error("âŒ Error getting storage analytics:",e),e}}async cleanupOldFiles(e=30){await o.C.cleanupOldFiles(e)}validateFileExtension(e){let t=e.split(".").pop()?.toLowerCase();return!!t&&["jpg","jpeg","png","gif","webp"].includes(t)}generateFileName(e){let t=e.split(".").pop()?.toLowerCase()||"jpg",a=Date.now(),r=Math.random().toString(36).substring(2,8);return`${a}_${r}.${t}`}constructor(){this.supabase=s.supabaseAdmin,this.getAllEvents=r.F.getAllEvents.bind(r.F),this.getPublicEvents=r.F.getPublicEvents.bind(r.F),this.getEventById=r.F.getEventById.bind(r.F),this.createEvent=r.F.createEvent.bind(r.F),this.updateEvent=r.F.updateEvent.bind(r.F),this.deleteEvent=r.F.deleteEvent.bind(r.F),this.verifyEventAccessCode=r.F.verifyEventAccessCode.bind(r.F),this.getEventPhotos=r.F.getEventPhotos.bind(r.F),this.getHomepagePhotos=r.F.getHomepagePhotos.bind(r.F),this.getPhotoById=r.F.getPhotoById.bind(r.F),this.deletePhoto=r.F.deletePhoto.bind(r.F),this.likePhoto=r.F.likePhoto.bind(r.F),this.getEventMessages=r.F.getEventMessages.bind(r.F),this.createMessage=r.F.createMessage.bind(r.F),this.heartMessage=r.F.heartMessage.bind(r.F),this.getMessageById=r.F.getMessageById.bind(r.F),this.updateMessageHearts=r.F.updateMessageHearts.bind(r.F),this.addMessageReaction=r.F.addMessageReaction.bind(r.F),this.updateMessageReactions=r.F.updateMessageReactions.bind(r.F),this.getStats=r.F.getStats.bind(r.F),this.getEvents=r.F.getEvents.bind(r.F),this.getSimpleCompressionAnalytics=r.F.getSimpleCompressionAnalytics.bind(r.F),this.validateEventAccess=r.F.validateEventAccess.bind(r.F)}}let n=new i},61646:(e,t,a)=>{a.d(t,{C:()=>s});let r=a(82481);class o{constructor(){this.initialized=!1,this.storageManager=new r({local:{backupFolder:process.env.LOCAL_BACKUP_PATH||"./DSLR-System/Backup/dslr-backup"}})}async initialize(){this.initialized||(await this.storageManager.initializeProviders(),this.initialized=!0,console.log("âœ… Storage Adapter initialized"))}async uploadPhoto(e,t){await this.initialize();let a=await e.arrayBuffer(),r={buffer:Buffer.from(a),name:e.name,size:e.size,type:e.type},o={eventId:t.eventId,albumName:t.albumName,uploaderName:t.uploaderName,isHomepage:t.isHomepage,isPremium:t.isPremium||!1,isFeatured:t.isFeatured||!1,fileSize:t.fileSize,eventType:t.eventType||"standard",fileType:t.fileType};console.log(`ðŸš€ Uploading ${e.name} via Smart Storage Manager`),console.log(`ðŸ“Š Metadata:`,o);try{let e=await this.storageManager.uploadPhoto(r,o);return console.log(`âœ… Upload successful:`,{tier:e.tier,storage:e.storage,url:e.url,size:e.size}),e}catch(e){throw console.error("âŒ Storage upload failed:",e),Error(`Storage upload failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async getStorageReport(){return await this.initialize(),this.storageManager.getStorageReport()}async cleanupOldFiles(e=30){await this.initialize(),await this.storageManager.cleanupOldFiles(e)}async hasStorageSpace(e,t){return await this.initialize(),this.storageManager.hasSpace(e,t)}async determineStorageTier(e){return await this.initialize(),this.storageManager.determineStorageTier(e)}}let s=new o}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[2782,606,3716,7851,8620,2481],()=>a(52252));module.exports=r})();