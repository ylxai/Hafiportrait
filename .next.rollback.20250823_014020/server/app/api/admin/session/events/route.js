"use strict";(()=>{var e={};e.id=280,e.ids=[280,7066],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},81841:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>f,patchFetch:()=>S,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>w,staticGenerationAsyncStorage:()=>v});var r={};s.r(r),s.d(r,{GET:()=>u,OPTIONS:()=>d,POST:()=>h});var n=s(30633),a=s(86488),i=s(13342),o=s(90223),l=s(45509),c=s(35872),p=s(87066);async function u(e){try{let{searchParams:t}=new URL(e.url),s=parseInt(t.get("limit")||"50"),r=parseInt(t.get("offset")||"0"),n=t.get("type"),a=p.OQ.from("session_events").select("*").order("timestamp",{ascending:!1}).range(r,r+s-1);n&&(a=a.eq("event_type",n));let{data:i,error:l}=await a;if(l)throw l;return o.NextResponse.json({success:!0,events:i||[],pagination:{limit:s,offset:r,total:i?.length||0}},{status:200,headers:c.eN})}catch(e){return console.error("Session events API error:",e),o.NextResponse.json({success:!1,error:"Failed to fetch session events"},{status:500,headers:c.eN})}}async function h(e){try{if("true"===process.env.DISABLE_SESSION_LOGGING)return o.NextResponse.json({success:!0,message:"Session event logging disabled in development"},{status:200,headers:c.eN});let{session_id:t,user_id:s,event_type:r,metadata:n}=await e.json();if(!t||!s||!r)return o.NextResponse.json({success:!0,message:"Session event ignored (missing fields)"},{status:200,headers:c.eN});let a=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"127.0.0.1",i=e.headers.get("user-agent")||"Unknown";return await l.F.logSessionEvent({session_id:t,user_id:s,event_type:r,ip_address:a,user_agent:i,metadata:n}),o.NextResponse.json({success:!0,message:"Session event logged successfully"},{status:200,headers:c.eN})}catch(e){return o.NextResponse.json({success:!0,message:"Session event processed"},{status:200,headers:c.eN})}}async function d(e){return new o.NextResponse(null,{status:200,headers:c.eN})}let g=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/session/events/route",pathname:"/api/admin/session/events",filename:"route",bundlePath:"app/api/admin/session/events/route"},resolvedPagePath:"/home/ubuntu/stable/src/app/api/admin/session/events/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:v,serverHooks:w}=g,f="/api/admin/session/events/route";function S(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:v})}},35872:(e,t,s)=>{s.d(t,{A6:()=>c,No:()=>i,VM:()=>o,eN:()=>a,qb:()=>l});var r=s(90223);function n(){let e=["https://hafiportrait.photography","https://www.hafiportrait.photography","https://hafiportrait.vercel.app","https://hafiportrait-git-main.vercel.app","https://hafiportrait-git-develop.vercel.app","https://*.vercel.app","https://*.vercel.app/*","https://hafiportrait.com","https://www.hafiportrait.com"];if(e.push("http://147.251.255.227:3002"),process.env.ALLOWED_ORIGINS){let t=process.env.ALLOWED_ORIGINS.split(",").map(e=>e.trim());e.push(...t)}return e}function a(e){let t={"Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS, PATCH","Access-Control-Allow-Headers":"Content-Type, Authorization, X-Requested-With, X-API-Key, X-User-ID, X-User-Username, X-User-Role","Access-Control-Allow-Credentials":"true","Access-Control-Max-Age":"86400"};if(!e||function(e){let t=n();return!!("https://hafiportrait.photography"===e||"https://www.hafiportrait.photography"===e||!e||e.includes("localhost")||e.includes("127.0.0.1"))||!!t.includes(e)||t.some(t=>{if(t.includes("*")){let s=t.replace(/\*/g,".*");return RegExp(`^${s}$`).test(e)}return!1})}(e))t["Access-Control-Allow-Origin"]=e||"*";else{let e=n();t["Access-Control-Allow-Origin"]=e[0]||"*"}return t}function i(e,t){return Object.entries(a(t)).forEach(([t,s])=>{e.headers.set(t,s)}),e}function o(e,t=200,s){return i(r.NextResponse.json(e,{status:t}),s)}function l(e,t=500,s){return i(r.NextResponse.json({error:e,timestamp:new Date().toISOString(),path:"/api/auth/login"},{status:t}),s)}function c(e){return i(new r.NextResponse(null,{status:200}),e)}},45509:(e,t,s)=>{s.d(t,{F:()=>n});var r=s(87066);class n{static async logSessionEvent(e){if("true"!==process.env.DISABLE_SESSION_LOGGING)try{if(!r.OQ){console.warn("Supabase not configured, skipping session event logging");return}let{error:t}=await r.OQ.from("session_events").insert({...e,timestamp:new Date().toISOString()})}catch(e){}}static async getSessionMetrics(){try{let{data:e,error:t}=await r.OQ.from("admin_sessions").select("*").gte("created_at",new Date(Date.now()-864e5).toISOString()).is("deleted_at",null);if(t)throw t;let{data:s,error:n}=await r.OQ.from("session_events").select("*").gte("timestamp",new Date(Date.now()-6048e5).toISOString()).order("timestamp",{ascending:!1});if(n)throw n;let a=e?.length||0,i=s?.filter(e=>"login"===e.event_type)||[],o=s?.filter(e=>"auth_failure"===e.event_type)||[],l=i.length>0?i.length/(i.length+o.length)*100:100,c=e?.map(e=>{let t=new Date(e.created_at);return new Date(e.last_activity||e.created_at).getTime()-t.getTime()})||[],p=c.length>0?c.reduce((e,t)=>e+t,0)/c.length:0,u={};i.forEach(e=>{let t=new Date(e.timestamp).getHours(),s=`${t}:00`;u[s]=(u[s]||0)+1});let h={};s?.forEach(e=>{let t=e.user_agent||"",s="Unknown";t.includes("Mobile")?s="Mobile":t.includes("Tablet")?s="Tablet":(t.includes("Desktop")||t.includes("Windows")||t.includes("Mac"))&&(s="Desktop"),h[s]=(h[s]||0)+1});let d=[...new Set(s?.map(e=>e.ip_address)||[])],g=s?.[0]?.timestamp?new Date(s[0].timestamp):new Date;return{totalActiveSessions:a,averageSessionDuration:p,loginSuccessRate:l,authFailureRate:100-l,sessionsByTimeOfDay:u,deviceTypes:h,ipAddresses:d,lastActivity:g}}catch(e){return console.error("Failed to get session metrics:",e),{totalActiveSessions:0,averageSessionDuration:0,loginSuccessRate:0,authFailureRate:0,sessionsByTimeOfDay:{},deviceTypes:{},ipAddresses:[],lastActivity:new Date}}}static async getSessionHealth(){let e=await this.getSessionMetrics(),t=[],s="healthy";return e.authFailureRate>20&&(t.push(`High auth failure rate: ${e.authFailureRate.toFixed(1)}%`),s="warning"),e.authFailureRate>50&&(s="critical"),0===e.totalActiveSessions&&(t.push("No active sessions detected"),s="warning"),Date.now()-e.lastActivity.getTime()>36e5&&(t.push("No recent activity detected"),s="warning"),{status:s,issues:t,metrics:e}}static async cleanupOldEvents(){try{let e=new Date(Date.now()-2592e6),{error:t}=await r.OQ.from("session_events").delete().lt("timestamp",e.toISOString());t?console.error("Failed to cleanup old session events:",t):console.log("Old session events cleaned up successfully")}catch(e){console.error("Session cleanup error:",e)}}}},87066:(e,t,s)=>{s.d(t,{OQ:()=>a,eI:()=>o,supabaseAdmin:()=>i});var r=s(33716);let n=()=>"https://azspktldiblhrwebzmwq.supabase.co",a=(0,r.eI)(n(),(()=>{let e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6c3BrdGxkaWJsaHJ3ZWJ6bXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NDQwNDQsImV4cCI6MjA2OTUyMDA0NH0.uKHB4K9hxUDTc0ZkwidCJv_Ev-oa99AflFvrFt_8MG8";if(!e)throw Error("NEXT_PUBLIC_SUPABASE_ANON_KEY environment variable is required");return e})()),i=(0,r.eI)(n(),(()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e)throw Error("SUPABASE_SERVICE_ROLE_KEY environment variable is required");return e})(),{auth:{autoRefreshToken:!1,persistSession:!1}});function o(){return(0,r.eI)("https://azspktldiblhrwebzmwq.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}process.env.SUPABASE_STORAGE_BUCKET}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[2782,606,3716],()=>s(81841));module.exports=r})();