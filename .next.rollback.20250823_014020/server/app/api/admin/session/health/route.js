"use strict";(()=>{var e={};e.id=8708,e.ids=[8708,7066],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},71568:e=>{e.exports=require("zlib")},63577:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>w,patchFetch:()=>S,requestAsyncStorage:()=>d,routeModule:()=>h,serverHooks:()=>g,staticGenerationAsyncStorage:()=>m});var r={};s.r(r),s.d(r,{GET:()=>p,OPTIONS:()=>u});var a=s(30633),i=s(86488),n=s(13342),o=s(90223),l=s(45509),c=s(35872);async function p(e){try{let e=await l.F.getSessionHealth();return o.NextResponse.json({success:!0,...e},{status:200,headers:c.eN})}catch(e){return console.error("Session health API error:",e),o.NextResponse.json({success:!1,error:"Failed to get session health data",status:"critical",issues:["Unable to fetch session metrics"],metrics:{totalActiveSessions:0,averageSessionDuration:0,loginSuccessRate:0,authFailureRate:100,sessionsByTimeOfDay:{},deviceTypes:{},ipAddresses:[],lastActivity:new Date}},{status:500,headers:c.eN})}}async function u(e){return new o.NextResponse(null,{status:200,headers:c.eN})}let h=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/session/health/route",pathname:"/api/admin/session/health",filename:"route",bundlePath:"app/api/admin/session/health/route"},resolvedPagePath:"/home/ubuntu/stable/src/app/api/admin/session/health/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:g}=h,w="/api/admin/session/health/route";function S(){return(0,n.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:m})}},35872:(e,t,s)=>{s.d(t,{A6:()=>c,No:()=>n,VM:()=>o,eN:()=>i,qb:()=>l});var r=s(90223);function a(){let e=["https://hafiportrait.photography","https://www.hafiportrait.photography","https://hafiportrait.vercel.app","https://hafiportrait-git-main.vercel.app","https://hafiportrait-git-develop.vercel.app","https://*.vercel.app","https://*.vercel.app/*","https://hafiportrait.com","https://www.hafiportrait.com"];if(e.push("http://147.251.255.227:3002"),process.env.ALLOWED_ORIGINS){let t=process.env.ALLOWED_ORIGINS.split(",").map(e=>e.trim());e.push(...t)}return e}function i(e){let t={"Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS, PATCH","Access-Control-Allow-Headers":"Content-Type, Authorization, X-Requested-With, X-API-Key, X-User-ID, X-User-Username, X-User-Role","Access-Control-Allow-Credentials":"true","Access-Control-Max-Age":"86400"};if(!e||function(e){let t=a();return!!("https://hafiportrait.photography"===e||"https://www.hafiportrait.photography"===e||!e||e.includes("localhost")||e.includes("127.0.0.1"))||!!t.includes(e)||t.some(t=>{if(t.includes("*")){let s=t.replace(/\*/g,".*");return RegExp(`^${s}$`).test(e)}return!1})}(e))t["Access-Control-Allow-Origin"]=e||"*";else{let e=a();t["Access-Control-Allow-Origin"]=e[0]||"*"}return t}function n(e,t){return Object.entries(i(t)).forEach(([t,s])=>{e.headers.set(t,s)}),e}function o(e,t=200,s){return n(r.NextResponse.json(e,{status:t}),s)}function l(e,t=500,s){return n(r.NextResponse.json({error:e,timestamp:new Date().toISOString(),path:"/api/auth/login"},{status:t}),s)}function c(e){return n(new r.NextResponse(null,{status:200}),e)}},45509:(e,t,s)=>{s.d(t,{F:()=>a});var r=s(87066);class a{static async logSessionEvent(e){if("true"!==process.env.DISABLE_SESSION_LOGGING)try{if(!r.OQ){console.warn("Supabase not configured, skipping session event logging");return}let{error:t}=await r.OQ.from("session_events").insert({...e,timestamp:new Date().toISOString()})}catch(e){}}static async getSessionMetrics(){try{let{data:e,error:t}=await r.OQ.from("admin_sessions").select("*").gte("created_at",new Date(Date.now()-864e5).toISOString()).is("deleted_at",null);if(t)throw t;let{data:s,error:a}=await r.OQ.from("session_events").select("*").gte("timestamp",new Date(Date.now()-6048e5).toISOString()).order("timestamp",{ascending:!1});if(a)throw a;let i=e?.length||0,n=s?.filter(e=>"login"===e.event_type)||[],o=s?.filter(e=>"auth_failure"===e.event_type)||[],l=n.length>0?n.length/(n.length+o.length)*100:100,c=e?.map(e=>{let t=new Date(e.created_at);return new Date(e.last_activity||e.created_at).getTime()-t.getTime()})||[],p=c.length>0?c.reduce((e,t)=>e+t,0)/c.length:0,u={};n.forEach(e=>{let t=new Date(e.timestamp).getHours(),s=`${t}:00`;u[s]=(u[s]||0)+1});let h={};s?.forEach(e=>{let t=e.user_agent||"",s="Unknown";t.includes("Mobile")?s="Mobile":t.includes("Tablet")?s="Tablet":(t.includes("Desktop")||t.includes("Windows")||t.includes("Mac"))&&(s="Desktop"),h[s]=(h[s]||0)+1});let d=[...new Set(s?.map(e=>e.ip_address)||[])],m=s?.[0]?.timestamp?new Date(s[0].timestamp):new Date;return{totalActiveSessions:i,averageSessionDuration:p,loginSuccessRate:l,authFailureRate:100-l,sessionsByTimeOfDay:u,deviceTypes:h,ipAddresses:d,lastActivity:m}}catch(e){return console.error("Failed to get session metrics:",e),{totalActiveSessions:0,averageSessionDuration:0,loginSuccessRate:0,authFailureRate:0,sessionsByTimeOfDay:{},deviceTypes:{},ipAddresses:[],lastActivity:new Date}}}static async getSessionHealth(){let e=await this.getSessionMetrics(),t=[],s="healthy";return e.authFailureRate>20&&(t.push(`High auth failure rate: ${e.authFailureRate.toFixed(1)}%`),s="warning"),e.authFailureRate>50&&(s="critical"),0===e.totalActiveSessions&&(t.push("No active sessions detected"),s="warning"),Date.now()-e.lastActivity.getTime()>36e5&&(t.push("No recent activity detected"),s="warning"),{status:s,issues:t,metrics:e}}static async cleanupOldEvents(){try{let e=new Date(Date.now()-2592e6),{error:t}=await r.OQ.from("session_events").delete().lt("timestamp",e.toISOString());t?console.error("Failed to cleanup old session events:",t):console.log("Old session events cleaned up successfully")}catch(e){console.error("Session cleanup error:",e)}}}},87066:(e,t,s)=>{s.d(t,{OQ:()=>i,eI:()=>o,supabaseAdmin:()=>n});var r=s(33716);let a=()=>"https://azspktldiblhrwebzmwq.supabase.co",i=(0,r.eI)(a(),(()=>{let e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6c3BrdGxkaWJsaHJ3ZWJ6bXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NDQwNDQsImV4cCI6MjA2OTUyMDA0NH0.uKHB4K9hxUDTc0ZkwidCJv_Ev-oa99AflFvrFt_8MG8";if(!e)throw Error("NEXT_PUBLIC_SUPABASE_ANON_KEY environment variable is required");return e})()),n=(0,r.eI)(a(),(()=>{let e=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e)throw Error("SUPABASE_SERVICE_ROLE_KEY environment variable is required");return e})(),{auth:{autoRefreshToken:!1,persistSession:!1}});function o(){return(0,r.eI)("https://azspktldiblhrwebzmwq.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})}process.env.SUPABASE_STORAGE_BUCKET}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[2782,606,3716],()=>s(63577));module.exports=r})();